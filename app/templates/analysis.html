<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Kripto Analiz Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: 'Montserrat', 'Segoe UI', sans-serif;
      background-color: #000;
      color: #fff;
      margin: 0;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background-color: #000;
      border-bottom: 1px solid #111;
    }
    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: #fff;
      letter-spacing: 1px;
    }
    nav a {
      margin: 0 1rem;
      color: #ccc;
      text-decoration: none;
      font-weight: 500;
      font-family: 'Montserrat', sans-serif;
    }
    nav a:hover {
      color: #fff;
    }
    .signup-btn {
      background-color: #FFD700;
      color: #000;
      padding: 0.5rem 1.2rem;
      border: none;
      border-radius: 999px;
      font-weight: bold;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      transition: background 0.2s, color 0.2s;
    }
    .signup-btn:hover {
      background: #fff;
      color: #FFD700;
    }
    .analysis-main {
      max-width: 900px;
      margin: 40px auto;
      background: #111;
      border-radius: 18px;
      box-shadow: 0 2px 16px #FFD70022;
      padding: 36px 32px;
    }
    .analysis-title {
      font-size: 2rem;
      text-align: center;
      color: #FFD700;
      margin-bottom: 24px;
    }
    .analysis-controls {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .control-group {
      text-align: center;
    }
    .control-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #FFD700;
    }
    select {
      padding: 10px 16px;
      border-radius: 8px;
      background-color: #222;
      color: #FFD700;
      border: 1.5px solid #FFD700;
      font-size: 1.08rem;
    }
    .chart-container {
      background: #18141c;
      border-radius: 12px;
      padding: 18px 10px;
      text-align: center;
      min-height: 420px;
    }
    #price-chart {
      width: 100%;
      min-height: 400px;
      background: #000;
      border-radius: 8px;
    }
    @media (max-width: 600px) {
      header {
        flex-direction: column;
        padding: 1rem 0.5rem;
      }
      nav a {
        margin: 0 0.5rem;
      }
      .analysis-main {
        max-width: 98vw;
        padding: 18px 8px;
      }
      .analysis-title {
        font-size: 1.3rem;
      }
      .analysis-controls {
        gap: 12px;
      }
      .chart-container {
        padding: 6px 2px;
      }
    }
    #crypto-sidebar {
      width: 320px;
      min-width: 220px;
      background: rgba(24,20,28,0.98);
      border-radius: 0 18px 18px 0;
      box-shadow: 2px 0 16px #FFD60022;
      padding: 28px 18px 24px 18px;
      position:fixed;
      top:0;
      left:0;
      height:100vh;
      z-index:1002;
      display:none;
      overflow-y:auto;
      transform:scale(0.7) rotateY(45deg);
      opacity:0;
      transition:all 0.5s cubic-bezier(.22,1.5,.36,1);
      scrollbar-width: thin;
      scrollbar-color: #FFD700 #18141c;
    }
    #crypto-sidebar::-webkit-scrollbar {
      width: 8px;
      background: #18141c;
      border-radius: 8px;
    }
    #crypto-sidebar::-webkit-scrollbar-thumb {
      background: #FFD700;
      border-radius: 8px;
    }
    #crypto-sidebar::-webkit-scrollbar-thumb:hover {
      background: #ffe066;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">Elite Crypto Panel</div>
    <nav>
      <a href="{{ url_for('main.analysis') }}" class="nav-link" data-vip="1" style="color:#FFD700;">Analiz</a>
      <a href="{{ url_for('main.news') }}" class="nav-link" data-vip="1">Haberler</a>
      <a href="{{ url_for('main.market_comment') }}" class="nav-link" data-vip="1">Piyasa Yorumu</a>
      {% if not session.get('is_vip') %}
      <a href="{{ url_for('main.buy') }}" class="nav-link" data-vip="0">VIP Satın Al</a>
      {% endif %}
    </nav>
    {% if session.get('user_email') %}
    <div style="position:relative;display:inline-block;">
      <button id="user-menu-btn" style="background:rgba(255,214,0,0.12);color:#FFD700;font-weight:bold;font-size:1.08rem;font-family:'Montserrat',sans-serif;border:2px solid #FFD700;border-radius:8px;padding:7px 18px;cursor:pointer;backdrop-filter:blur(2px);transition:background 0.2s;">
        {{ session.get('user_email') }}
      </button>
      <div id="user-menu-dropdown" style="display:none;position:absolute;right:0;top:110%;background:rgba(24,20,28,0.98);border:1.5px solid #FFD600;border-radius:12px;box-shadow:0 4px 24px #FFD60022;min-width:180px;z-index:9999;">
        <a href="{{ url_for('main.index') }}" style="display:block;padding:12px 18px;color:#FFD600;font-family:'Montserrat',sans-serif;text-decoration:none;font-size:1.05rem;border-bottom:1px solid #FFD60022;">Anasayfa</a>
        <a href="{{ url_for('main.buy') }}" style="display:block;padding:12px 18px;color:#FFD600;font-family:'Montserrat',sans-serif;text-decoration:none;font-size:1.05rem;border-bottom:1px solid #FFD60022;">VIP Satın Al</a>
        <a href="{{ url_for('main.logout') }}" id="logout-link" style="display:block;padding:12px 18px;color:#ff1744;font-family:'Montserrat',sans-serif;text-decoration:none;font-size:1.05rem;">Çıkış Yap</a>
      </div>
    </div>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
      var btn = document.getElementById('user-menu-btn');
      var menu = document.getElementById('user-menu-dropdown');
      if (btn && menu) {
        btn.onclick = function(e) {
          e.stopPropagation();
          menu.style.display = (menu.style.display === "block") ? "none" : "block";
        };
        document.addEventListener('mousedown', function(e) {
          if (!menu.contains(e.target) && e.target !== btn) {
            menu.style.display = "none";
          }
        });
      }
    });
    </script>
    {% else %}
      <a href="{{ url_for('main.login') }}"><button class="signup-btn">Giriş Yap</button></a>
    {% endif %}
  </header>
  <div style="text-align:center;color:#FFD700;font-size:1.25rem;font-weight:bold;margin-top:12px;margin-bottom:0;">
    {{ selected_coin.name if selected_coin else symbol }}
  </div>

  <!-- Koin seçme menüsü (sidebar ve buton) -->
  <button id="open-sidebar-btn" style="position:fixed;top:120px;left:0;z-index:1001;background:#FFD700;color:#18141c;font-weight:bold;border:none;border-radius:0 12px 12px 0;padding:16px 12px 16px 6px;cursor:pointer;box-shadow:2px 2px 12px #FFD70044;">&#9776; Kripto Seç</button>
  <aside id="crypto-sidebar" style="width: 320px; min-width: 220px; background: rgba(24,20,28,0.98); border-radius: 0 18px 18px 0; box-shadow: 2px 0 16px #FFD60022; padding: 28px 18px 24px 18px; position:fixed; top:0; left:0; height:100vh; z-index:1002; display:none; overflow-y:auto; transform:scale(0.7) rotateY(45deg); opacity:0; transition:all 0.5s cubic-bezier(.22,1.5,.36,1); scrollbar-width: thin; scrollbar-color: #FFD700 #18141c;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <span style="color:#FFD600;font-size:1.18rem;font-weight:bold;">Kripto Seçimi</span>
      <button id="close-sidebar-btn" style="background:none;border:none;color:#FFD600;font-size:1.5rem;cursor:pointer;">&times;</button>
    </div>
    <div style="width:100%;display:flex;justify-content:center;">
      <input type="text" id="coin-search" placeholder="Kripto ara..." style="margin-bottom:14px;padding:8px 12px;border-radius:8px;border:1px solid #FFD600;width:90%;background:#18141c;color:#FFD600;font-size:1rem;display:block;">
    </div>
    <form method="post" id="main-form" style="display: flex; flex-direction: column; gap: 18px;">
      <input type="hidden" name="hidden_symbol" id="hidden_symbol" value="{{ symbol }}">
      <!-- Seçili coin en üstte göster -->
      {% set selected_coin = coins | selectattr('symbol', 'equalto', symbol) | list | first %}
      {% if selected_coin %}
      <div id="selected-coin" style="display:flex;justify-content:center;margin-bottom:12px;align-items:center;gap:8px;">
        <button type="submit" name="symbol" value="{{ selected_coin.symbol }}"
          class="coin-btn"
          style="background:#FFD600;color:#18141c;border:2px solid #FFD600;border-radius:12px;padding:12px 24px;font-weight:bold;cursor:pointer;box-shadow:0 0 16px #FFD60088;display:flex;align-items:center;gap:8px;font-size:1.08rem;">
          <!-- icon kaldırıldı -->
          <span>{{ selected_coin.name }}</span>
          {% if selected_coin.symbol in favorite_symbols %}
            <span class="fav-toggle" data-symbol="{{ selected_coin.symbol }}" data-fav="1" style="margin-left:4px;color:#18141c;font-size:1.2em;cursor:pointer;">★</span>
          {% else %}
            <span class="fav-toggle" data-symbol="{{ selected_coin.symbol }}" data-fav="0" style="margin-left:4px;color:#00e676;font-size:1.2em;cursor:pointer;">☆</span>
          {% endif %}
        </button>
      </div>
      {% endif %}
      <!-- Favoriler (seçili coin hariç) -->
      <div id="favorite-coins" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom:10px; justify-content: center;">
        {% for coin in coins if coin.symbol in favorite_symbols and coin.symbol != symbol %}
        <div style="display:flex;align-items:center;gap:6px;">
          <button type="submit" name="symbol" value="{{ coin.symbol }}"
            class="coin-btn favorite-coin"
            style="background:#00e676;color:#18141c;border:2px solid #00e676;border-radius:10px;padding:10px 18px 10px 18px;font-weight:bold;cursor:pointer;position:relative;display:flex;align-items:center;gap:6px;"
          >
            <!-- icon kaldırıldı -->
            <span>{{ coin.name }}</span>
            <span class="fav-toggle" data-symbol="{{ coin.symbol }}" data-fav="1" style="margin-left:4px;color:#18141c;font-size:1.1em;cursor:pointer;">★</span>
          </button>
        </div>
        {% endfor %}
      </div>
      <!-- Diğer coinler (seçili coin hariç) -->
      <div id="coin-buttons" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
        {% for coin in coins if coin.symbol not in favorite_symbols and coin.symbol != symbol %}
        <div style="display:flex;align-items:center;gap:6px;">
          <button type="submit" name="symbol" value="{{ coin.symbol }}"
            class="coin-btn"
            style="background:#18141c;color:#FFD600;border:2px solid #FFD600;border-radius:10px;padding:10px 18px 10px 18px;font-weight:bold;cursor:pointer;position:relative;display:flex;align-items:center;gap:6px;transition:background 0.2s;"
          >
            <!-- icon kaldırıldı -->
            <span>{{ coin.name }}</span>
            <span class="fav-toggle" data-symbol="{{ coin.symbol }}" data-fav="0" style="margin-left:4px;color:#00e676;font-size:1.1em;cursor:pointer;">☆</span>
          </button>
        </div>
        {% endfor %}
      </div>
    </form>
  </aside>
  <script>
    // DEBUG: Coin ve ikon verilerini konsola yazdır
    document.addEventListener("DOMContentLoaded", function() {
      try {
        var coinBtns = document.querySelectorAll('.coin-btn');
        console.log("DEBUG: coin-btn count:", coinBtns.length);
        coinBtns.forEach(function(btn) {
          var img = btn.querySelector('img');
          var name = btn.querySelector('span') ? btn.querySelector('span').innerText : '';
          if (img) {
            console.log("DEBUG: Coin:", name, "IMG SRC:", img.src);
          } else {
            console.log("DEBUG: Coin:", name, "NO IMG");
          }
        });
      } catch (e) {
        console.error("DEBUG ERROR:", e);
      }
    });
  </script>

  <div class="analysis-main">
    <div class="analysis-title">Fiyat Grafiği</div>
    <form method="post" id="chart-options-form">
      <div class="analysis-controls">
        <div class="control-group">
          <label for="interval">Zaman Aralığı:</label>
          <select name="interval" id="interval">
            <option value="1d" {% if interval == '1d' %}selected{% endif %}>1 Gün</option>
            <option value="1w" {% if interval == '1w' %}selected{% endif %}>1 Hafta</option>
            <option value="1M" {% if interval == '1M' %}selected{% endif %}>1 Ay</option>
            <option value="1h" {% if interval == '1h' %}selected{% endif %}>1 Saat</option>
            <option value="15m" {% if interval == '15m' %}selected{% endif %}>15 Dakika</option>
          </select>
        </div>
        <div class="control-group">
          <label for="chart_type">Görüntülenecek Grafik:</label>
          <select name="chart_type" id="chart_type">
            <option value="candlestick" {% if chart_type == 'candlestick' %}selected{% endif %}>Mum Grafiği</option>
            <option value="rsi" {% if chart_type == 'rsi' %}selected{% endif %}>RSI</option>
            <option value="macd" {% if chart_type == 'macd' %}selected{% endif %}>MACD</option>
          </select>
        </div>
      </div>
      <input type="hidden" name="hidden_symbol" id="hidden_symbol" value="{{ symbol }}">
    </form>
    <div class="chart-container">
      <div id="price-chart"></div>
    </div>
  </div>

  <script type="text/javascript">
    var chartData = {{ chart_data | tojson | safe }};
    var chartType = "{{ chart_type }}";
    var traces = [];
    if (chartType === "candlestick") {
      traces.push({
        x: chartData.dates,
        open: chartData.open,
        high: chartData.high,
        low: chartData.low,
        close: chartData.close,
        type: 'candlestick',
        name: 'Fiyat',
        increasing: {line: {color: 'green'}},
        decreasing: {line: {color: 'red'}}
      });
      if (chartData.support_trend && chartData.support_trend.length > 0) {
        traces.push({
          x: chartData.support_trend.map(pt => new Date(pt[0] * 1000)),
          y: chartData.support_trend.map(pt => pt[1]),
          type: 'scatter',
          mode: 'lines',
          name: 'Destek Trend Çizgisi',
          line: {color: 'green', dash: 'dash'},
          legendgroup: 'Destek Trend',
          showlegend: true,
          hovertemplate: '<b>Destek Trend Çizgisi</b><br>Tarih: %{x}<br>Fiyat: %{y:.2f}<extra></extra>'
        });
      }
      if (chartData.resistance_trend && chartData.resistance_trend.length > 0) {
        traces.push({
          x: chartData.resistance_trend.map(pt => new Date(pt[0] * 1000)),
          y: chartData.resistance_trend.map(pt => pt[1]),
          type: 'scatter',
          mode: 'lines',
          name: 'Direnç Trend Çizgisi',
          line: {color: 'red', dash: 'dash'},
          legendgroup: 'Direnç Trend',
          showlegend: true,
          hovertemplate: '<b>Direnç Trend Çizgisi</b><br>Tarih: %{x}<br>Fiyat: %{y:.2f}<extra></extra>'
        });
      }
    } else if (chartType === "rsi") {
      traces.push({
        x: chartData.dates,
        y: chartData.rsi,
        type: 'scatter',
        mode: 'lines',
        name: 'RSI',
        line: {color: 'orange'}
      });
    } else if (chartType === "macd") {
      traces.push({
        x: chartData.dates,
        y: chartData.macd,
        type: 'scatter',
        mode: 'lines',
        name: 'MACD',
        line: {color: 'cyan'}
      });
      traces.push({
        x: chartData.dates,
        y: chartData.macd_signal,
        type: 'scatter',
        mode: 'lines',
        name: 'MACD Signal',
        line: {color: 'magenta'}
      });
    }
    var layout = {
      title: '',
      xaxis: { title: 'Tarih', rangeslider: {visible: false} },
      yaxis: { 
        title: chartType === "candlestick" ? 'Fiyat' : (chartType === "rsi" ? 'RSI' : 'MACD'),
        fixedrange: false
      },
      dragmode: 'pan',
      template: 'plotly_dark',
      legend: {orientation: 'h', yanchor: 'bottom', y: 1.02, xanchor: 'right', x: 1},
      hovermode: chartType === "candlestick" ? 'x unified' : 'closest',
      height: 420,
      paper_bgcolor: "#000",
      plot_bgcolor: "#000"
    };
    var config = {
      scrollZoom: true,
      displaylogo: false,
      responsive: true,
      modeBarButtonsToRemove: ['select2d', 'lasso2d'],
      doubleClick: 'reset+autosize',
      staticPlot: false
    };
    Plotly.newPlot('price-chart', traces, layout, config);

    // AJAX ile grafik güncelleme
    document.addEventListener("DOMContentLoaded", function() {
      var chartForm = document.getElementById('chart-options-form');
      chartForm.querySelectorAll('select').forEach(function(sel) {
        sel.addEventListener('change', function(e) {
          e.preventDefault();
          var formData = new FormData(chartForm);
          var xhr = new XMLHttpRequest();
          xhr.open("POST", window.location.pathname, true);
          xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
          xhr.onload = function() {
            if (xhr.status === 200) {
              var resp = JSON.parse(xhr.responseText);
              Plotly.react('price-chart', resp.traces, resp.layout, resp.config);
            }
          };
          xhr.send(formData);
        });
      });
    });
  </script>
  <script>
    // Sidebar aç/kapat fonksiyonu ve animasyon
    document.addEventListener("DOMContentLoaded", function() {
      var sidebar = document.getElementById('crypto-sidebar');
      var openBtn = document.getElementById('open-sidebar-btn');
      var closeBtn = document.getElementById('close-sidebar-btn');
      openBtn.onclick = function() {
        sidebar.style.display = "block";
        sidebar.style.transition = "none";
        sidebar.style.transform = "scale(0.7) rotateY(45deg)";
        sidebar.style.opacity = "0";
        void sidebar.offsetWidth;
        sidebar.style.transition = "all 0.5s cubic-bezier(.22,1.5,.36,1)";
        sidebar.style.transform = "scale(1) rotateY(0deg)";
        sidebar.style.opacity = "1";
      };
      closeBtn.onclick = function() {
        sidebar.style.transform = "scale(0.7) rotateY(45deg)";
        sidebar.style.opacity = "0";
        setTimeout(function(){ sidebar.style.display = "none"; }, 500);
      };
      document.addEventListener('mousedown', function(e) {
        if (sidebar.style.transform === "scale(1) rotateY(0deg)" && !sidebar.contains(e.target) && e.target !== openBtn) {
          sidebar.style.transform = "scale(0.7) rotateY(45deg)";
          sidebar.style.opacity = "0";
          setTimeout(function(){ sidebar.style.display = "none"; }, 500);
        }
      });
      // Arama özelliği
      var searchInput = document.getElementById('coin-search');
      var coinButtonsDiv = document.getElementById('coin-buttons');
      if (searchInput && coinButtonsDiv) {
        searchInput.addEventListener('input', function() {
          var filter = searchInput.value.toLowerCase();
          var buttons = coinButtonsDiv.querySelectorAll('.coin-btn');
          buttons.forEach(function(btn) {
            var text = btn.textContent.toLowerCase();
            btn.style.display = text.includes(filter) ? '' : 'none';
          });
        });
      }
      // Favori ekleme/çıkarma (tek yıldız ile)
      document.querySelectorAll('.fav-toggle').forEach(function(star) {
        star.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          var symbol = this.getAttribute('data-symbol');
          fetch('/favorite', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({symbol: symbol})
          })
          .then(resp => resp.json())
          .then(function(data) {
            if(data.success) {
              // Sadece favori butonlarını güncelle
              updateFavoritesUI(symbol);
            }
          });
        });
      });

      function updateFavoritesUI(symbol) {
        var favBtn = document.querySelector('.fav-toggle[data-symbol="' + symbol + '"]');
        if (!favBtn) return;
        var parentBtn = favBtn.closest('button');
        var selectedCoinDiv = document.getElementById('selected-coin');
        var favList = document.getElementById('favorite-coins');
        var coinList = document.getElementById('coin-buttons');
        var isSelected = selectedCoinDiv && selectedCoinDiv.contains(parentBtn);
        var isFav = favBtn.getAttribute('data-fav') === "1";
        if (isSelected) {
          if (isFav) {
            favBtn.innerText = "☆";
            favBtn.style.color = "#00e676";
            favBtn.setAttribute('data-fav', "0");
          } else {
            favBtn.innerText = "★";
            favBtn.style.color = "#18141c";
            favBtn.setAttribute('data-fav', "1");
          }
        } else {
          if (isFav) {
            favBtn.innerText = "☆";
            favBtn.style.color = "#00e676";
            favBtn.setAttribute('data-fav', "0");
            parentBtn.classList.remove('favorite-coin');
            parentBtn.style.background = "#18141c";
            parentBtn.style.color = "#FFD600";
            parentBtn.style.border = "2px solid #FFD600";
            coinList.appendChild(parentBtn);
          } else {
            favBtn.innerText = "★";
            favBtn.style.color = "#18141c";
            favBtn.setAttribute('data-fav', "1");
            parentBtn.classList.add('favorite-coin');
            parentBtn.style.background = "#00e676";
            parentBtn.style.color = "#18141c";
            parentBtn.style.border = "2px solid #00e676";
            favList.appendChild(parentBtn);
          }
        }
      }
    });
    // CoinGecko ikonlarını tüm sayfada göster
    document.addEventListener("DOMContentLoaded", function() {
      function addCoinGeckoIcons() {
        document.querySelectorAll('[data-coingecko-id][data-coingecko-image-id]').forEach(function(el) {
          if (!el.querySelector('.cg-icon')) {
            var img = document.createElement('img');
            img.className = 'cg-icon';
            img.src = 'https://assets.coingecko.com/coins/images/' + el.getAttribute('data-coingecko-image-id') + '/thumb.png';
            img.alt = el.getAttribute('data-coingecko-id') + ' icon';
            img.style = 'width:20px;height:20px;border-radius:50%;background:#fff;margin-right:6px;vertical-align:middle;';
            img.onerror = function() { this.style.display = 'none'; };
            el.insertBefore(img, el.firstChild);
          }
        });
      }
      addCoinGeckoIcons();
      // Eğer dinamik olarak coin ekleniyorsa, tekrar çağırabilirsiniz.
    });
  </script>
  <!-- ...existing code... -->
  <script>
  // ...existing code...
  // Tüm dinamik Trust Wallet ve CoinGecko JS ikon kodlarını kaldırın!
  // Sadece yukarıdaki Jinja img tag'ları ile gösterim yapılır.
</script>
<!-- ...existing code... -->
</body>
</html>